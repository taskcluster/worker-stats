{"version":3,"file":"log_test.js","sources":["@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/3","@traceur/generated/TemplateParser/0","../../src/store/log.js","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/2","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/7","../../src/store/log_test.js","@traceur/generated/TemplateParser/8"],"names":[],"mappings":"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","sourcesContent":["$traceurRuntime.ModuleStore.registerModule($__placeholder__0,\n            $__placeholder__1);","function() {\n      $__placeholder__0\n    }","var __moduleName = $__placeholder__0;","/*jshint esnext:true */\nvar COMPLETE_HEADER = 'x-ms-meta-complete';\n\nfunction req(method, url) {\n  return superagent(method, url).\n            set('x-ms-version', '2013-08-15');\n}\n\nfunction getReq(logger) {\n  var current = req('GET', logger.url);\n  if (logger.etag) current.set('If-None-Match', logger.etag);\n  if (logger.offset) current.set('Range', 'bytes=' + logger.offset + '-');\n  return current;\n}\n\nfunction headReq(logger) {\n  var current = req('HEAD', logger.url);\n  if (logger.etag) current.set('If-None-Match', logger.etag);\n  return current;\n}\n\nfunction logIsComplete(req) {\n  return req.headers['x-ms-meta-complete'];\n}\n\nexport class Log {\n  constructor(url, interval=1000) {\n    this.url = url;\n    this.offset = 0;\n    this.complete = false;\n    this.etag = null;\n    this.interval = interval;\n\n    this.aborted = false;\n    this.onerror = function() {};\n    this.ondata = function() {};\n    this.onend = function() {};\n    this._read();\n  }\n\n  _waitForEtagChange() {\n    headReq(this).end((err, res) => {\n      if (res.ok) {\n        // must have made at least one get is complete\n        if (this.etag && logIsComplete(res)) return this._complete();\n        return this._read();\n      }\n\n      // otherwise wait for new content\n      setTimeout(this._waitForEtagChange.bind(this), this.interval);\n    });\n  }\n\n  _complete() {\n    if (!this.complete) {\n      this.complete = true;\n      this.onend();\n    }\n  }\n\n  _read() {\n    var req = getReq(this);\n    var progress;\n\n    req.end((err, res) => {\n      if (err) {\n        this.aborted = true;\n        return this.onerror(err);\n      }\n\n      // if the get request was not okay check for new data after the interval.\n      if (!res.ok) {\n        return setTimeout(\n          this._waitForEtagChange.bind(this),\n          this.interval\n        );\n      }\n\n      this.ondata(res.text);\n      this.etag = res.header.etag;\n\n      if (progress) this.offset += progress.total || 0;\n      if (logIsComplete(res)) this._complete();\n      if (!this.complete) this._waitForEtagChange();\n    });\n\n    // keep track of the last status event to get the binary offset of the log.\n    req.xhr.addEventListener('progress', (status) => {\n      progress = status;\n    });\n  }\n}\n","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2)","return $__placeholder__0","get $__placeholder__0() { return $__placeholder__1; }","$traceurRuntime.getModuleImpl($__placeholder__0)","/*jshint esnext:true */\nimport {Log} from './log';\nsuite('store/log', function() {\n  var url = 'http://taskclusterlog.blob.core.windows.net/taskclusterlogs/08890cb0-dac7-46b9-ad09-28cfd3a65f27';\n\n  test('fetch an entire log', function(done) {\n    var log = new Log(url);\n    var content = '';\n    log.ondata = function(value) {\n      content += value;\n    };\n\n    log.onerror = done;\n    log.onend = () => {\n      assert.ok(log.complete);\n      assert.ok(content.length, 'has contents');\n      assert.ok(log.offset >= content.length, 'offset is >= then length');\n      done();\n    };\n  });\n});\n","System.get($__placeholder__0 +'')"]}